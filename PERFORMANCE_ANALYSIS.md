# å¯¼å…¥æ€§èƒ½åˆ†ææŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

æœ¬æ¬¡å‹åŠ›æµ‹è¯•å¯¼å…¥10,000æ¡è½¨è¿¹æ•°æ®ï¼Œè€—æ—¶**11å°æ—¶39åˆ†é’Ÿ**ï¼Œæ€§èƒ½è¿œä½äºé¢„æœŸã€‚

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | å€¼ | è¯´æ˜ |
|------|------|------|
| æ€»å¯¼å…¥æ—¶é—´ | 11å°æ—¶39åˆ†é’Ÿ (41,977ç§’) | å®é™…æµ‹è¯•ç»“æœ |
| æ•°æ®é‡ | 10,000æ¡è½¨è¿¹ | 1,000ä¸ªé—®é¢˜ Ã— 10æ¡è½¨è¿¹/é—®é¢˜ |
| å®é™…ååé‡ | **0.24æ¡/ç§’** | ~14æ¡/åˆ†é’Ÿ |
| é¢„æœŸååé‡ | 30-50æ¡/ç§’ | åŸºäºç³»ç»Ÿæ¶æ„é¢„ä¼° |
| æ€§èƒ½å·®è· | **200å€** | ä¸¥é‡æ€§èƒ½ç“¶é¢ˆ |
| æºæ–‡ä»¶å¤§å° | 36MB | JSONLæ ¼å¼ |
| æœ€ç»ˆæ•°æ®åº“å¤§å° | 6.2GB | è†¨èƒ€172å€ |
| å¹³å‡æ¯æ¡è®°å½• | 640KB | åŒ…å«å‘é‡ç´¢å¼• |

## æ ¹æœ¬åŸå› åˆ†æ

### ä¸»è¦ç“¶é¢ˆï¼šé€æ¡æ’å…¥ (N+1é—®é¢˜)

**é—®é¢˜ä»£ç ä½ç½®**: `backend/services/import_service.py:445, 486`

```python
# å½“å‰ä»£ç ï¼ˆé—®é¢˜ï¼‰
self.repository.add(trajectory)  # é€æ¡æ’å…¥ï¼Œè°ƒç”¨10,000æ¬¡
```

**å½±å“**:
- æ¯æ¬¡æ’å…¥éƒ½ä¼šè§¦å‘å®Œæ•´çš„LanceDBäº‹åŠ¡
- æ¯æ¬¡æ’å…¥éƒ½ä¼šæ›´æ–°å‘é‡ç´¢å¼•
- æ¯æ¬¡æ’å…¥éƒ½ä¼šåˆ·æ–°ç£ç›˜
- å¯¼è‡´10,000æ¬¡ç‹¬ç«‹äº‹åŠ¡å’Œç£ç›˜I/Oæ“ä½œ

### æ¬¡è¦ç“¶é¢ˆ

1. **å‘é‡ç”Ÿæˆå¼€é”€**
   - æ¯æ¡è®°å½•éƒ½éœ€è¦ç”Ÿæˆ384ç»´å‘é‡
   - ä½¿ç”¨hashç®—æ³•æ¨¡æ‹Ÿå‘é‡ï¼Œä½†ä»æœ‰è®¡ç®—å¼€é”€

2. **é‡å¤æ•°æ®æ£€æŸ¥**
   - æ¯æ¡è®°å½•æ’å…¥å‰éƒ½è°ƒç”¨`repository.get()`æ£€æŸ¥é‡å¤
   - é¢å¤–çš„10,000æ¬¡æŸ¥è¯¢æ“ä½œ

3. **æ•°æ®åºåˆ—åŒ–**
   - æ¯æ¡è®°å½•éƒ½è¿›è¡ŒJSONåºåˆ—åŒ–ï¼ˆsteps, chat_completionsï¼‰
   - æ²¡æœ‰æ‰¹é‡åºåˆ—åŒ–ä¼˜åŒ–

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### æ–¹æ¡ˆ1ï¼šæ‰¹é‡æ’å…¥ï¼ˆæ¨èï¼‰ â­

**ä¼˜å…ˆçº§**: é«˜  
**é¢„æœŸæå‡**: 50-100å€  
**å®æ–½éš¾åº¦**: ä½

ä¿®æ”¹ `import_service.py` ä½¿ç”¨æ‰¹é‡æ’å…¥ï¼š

```python
# æ”¶é›†æ‰¹é‡
batch = []
batch_size = 500  # æ¯æ‰¹500æ¡

for traj_data in trajectories:
    # ... éªŒè¯å’Œæ ‡å‡†åŒ– ...
    trajectory = Trajectory(**traj_data)
    batch.append(trajectory)
    
    # æ‰¹é‡æ’å…¥
    if len(batch) >= batch_size:
        self.repository.add_batch(batch)
        result.imported_count += len(batch)
        batch = []

# æ’å…¥å‰©ä½™è®°å½•
if batch:
    self.repository.add_batch(batch)
    result.imported_count += len(batch)
```

**é¢„æœŸæ•ˆæœ**:
- å°†10,000æ¬¡æ’å…¥å‡å°‘åˆ°20æ¬¡ï¼ˆ500æ¡/æ‰¹ï¼‰
- å‡å°‘äº‹åŠ¡å¼€é”€
- å‡å°‘ç£ç›˜I/O
- é¢„è®¡å¯¼å…¥æ—¶é—´: **10-15åˆ†é’Ÿ**

### æ–¹æ¡ˆ2ï¼šç§»é™¤é‡å¤æ£€æŸ¥

**ä¼˜å…ˆçº§**: ä¸­  
**é¢„æœŸæå‡**: 2-3å€  
**å®æ–½éš¾åº¦**: ä½

å¯¹äºæ‰¹é‡å¯¼å…¥ï¼Œå¯ä»¥è·³è¿‡é‡å¤æ£€æŸ¥æˆ–ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢ï¼š

```python
# é€‰é¡¹1: è·³è¿‡é‡å¤æ£€æŸ¥ï¼ˆæ•°æ®å»é‡åœ¨å¯¼å…¥å‰å®Œæˆï¼‰
# self.repository.get(traj_id)  # æ³¨é‡Šæ‰

# é€‰é¡¹2: æ‰¹é‡æ£€æŸ¥å·²å­˜åœ¨çš„ID
existing_ids = set(self.get_existing_ids())
```

### æ–¹æ¡ˆ3ï¼šå¼‚æ­¥æ‰¹é‡å¤„ç†

**ä¼˜å…ˆçº§**: ä¸­  
**é¢„æœŸæå‡**: 1.5-2å€  
**å®æ–½éš¾åº¦**: ä¸­

ä½¿ç”¨asyncioå¹¶å‘å¤„ç†å¤šä¸ªæ‰¹æ¬¡ï¼š

```python
async def process_batch(batch):
    # å¤„ç†å¹¶æ’å…¥ä¸€ä¸ªæ‰¹æ¬¡
    self.repository.add_batch(batch)

# å¹¶å‘å¤„ç†å¤šä¸ªæ‰¹æ¬¡
tasks = [process_batch(batch) for batch in batches]
await asyncio.gather(*tasks)
```

### æ–¹æ¡ˆ4ï¼šæ•°æ®åº“é…ç½®ä¼˜åŒ–

**ä¼˜å…ˆçº§**: ä½  
**é¢„æœŸæå‡**: 1.2-1.5å€  
**å®æ–½éš¾åº¦**: ä½

LanceDBé…ç½®ä¼˜åŒ–ï¼š
- å¢åŠ ç¼“å­˜å¤§å°
- è°ƒæ•´ç´¢å¼•æ„å»ºå‚æ•°
- ä½¿ç”¨æ›´å¿«çš„å­˜å‚¨ï¼ˆSSDï¼‰

## å»ºè®®å®æ–½é¡ºåº

1. **ç«‹å³å®æ–½**: æ‰¹é‡æ’å…¥ï¼ˆæ–¹æ¡ˆ1ï¼‰- æœ€å¤§æ”¶ç›Š
2. **çŸ­æœŸ**: ç§»é™¤/ä¼˜åŒ–é‡å¤æ£€æŸ¥ï¼ˆæ–¹æ¡ˆ2ï¼‰
3. **ä¸­æœŸ**: å¼‚æ­¥æ‰¹é‡å¤„ç†ï¼ˆæ–¹æ¡ˆ3ï¼‰
4. **é•¿æœŸ**: æ•°æ®åº“é…ç½®ä¼˜åŒ–ï¼ˆæ–¹æ¡ˆ4ï¼‰

## å…¶ä»–å‘ç°

### æ•°æ®è†¨èƒ€åˆ†æ

- æºæ•°æ®: 36MB
- æ•°æ®åº“: 6.2GB
- è†¨èƒ€å€æ•°: 172å€

**åŸå› **:
1. å‘é‡ç´¢å¼•å­˜å‚¨ (384ç»´ Ã— 4å­—èŠ‚ Ã— 10,000 â‰ˆ 15MB)
2. LanceDBå…ƒæ•°æ®å’Œç´¢å¼•ç»“æ„
3. JSONåºåˆ—åŒ–åçš„stepså’Œchat_completionså ç”¨æ›´å¤šç©ºé—´
4. åˆ—å¼å­˜å‚¨çš„åˆ—å¼€é”€

**å»ºè®®**:
- è€ƒè™‘å‹ç¼©é…ç½®
- å¯¹ä¸å¿…è¦çš„å¤§å­—æ®µä½¿ç”¨å¤–éƒ¨å­˜å‚¨
- å®šæœŸæ¸…ç†æ—§æ•°æ®

### å†…å­˜ä½¿ç”¨

å¯¼å…¥æœŸé—´å†…å­˜ä½¿ç”¨: ~1.9GB
- Pythonè¿›ç¨‹æœ¬èº«: ~500MB
- LanceDBç¼“å­˜: ~1GB+
- æ•°æ®å¤„ç†: ~400MB

**å»ºè®®**: æ‰¹é‡æ’å…¥åå†…å­˜ä½¿ç”¨åº”è¯¥é™ä½

## æµ‹è¯•ç»“è®º

å½“å‰ç³»ç»Ÿåœ¨å¤„ç†å¤§è§„æ¨¡æ•°æ®å¯¼å…¥æ—¶å­˜åœ¨**ä¸¥é‡æ€§èƒ½ç“¶é¢ˆ**ï¼Œä¸»è¦åŸå› æ˜¯æœªä½¿ç”¨æ‰¹é‡æ’å…¥ã€‚

å®æ–½æ‰¹é‡æ’å…¥ä¼˜åŒ–åï¼Œé¢„è®¡å¯ä»¥å°†å¯¼å…¥æ—¶é—´ä»**11å°æ—¶**é™ä½åˆ°**10-15åˆ†é’Ÿ**ï¼Œæå‡**50-100å€**ã€‚

## æŸ¥è¯¢æ€§èƒ½æµ‹è¯•

åœ¨10,000æ¡è½¨è¿¹æ•°æ®çš„åŸºç¡€ä¸Šè¿›è¡Œäº†æŸ¥è¯¢æ€§èƒ½æµ‹è¯•ï¼Œå‘ç°**æŸ¥è¯¢æ€§èƒ½åŒæ ·å­˜åœ¨ä¸¥é‡é—®é¢˜**ã€‚

### æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡

| æŸ¥è¯¢ç±»å‹ | è€—æ—¶ | è¿”å›è®°å½•æ•° | ååé‡ | çŠ¶æ€ |
|---------|------|-----------|--------|------|
| è·å–ç»Ÿè®¡ä¿¡æ¯ | 43,039ms (43ç§’) | 10,000 | 232æ¡/ç§’ | ğŸ”´ ææ…¢ |
| è·å–è½¨è¿¹åˆ—è¡¨(limit=100) | 9,447ms (9.4ç§’) | 20 | 2æ¡/ç§’ | ğŸ”´ æ…¢ |
| è·å–è½¨è¿¹åˆ—è¡¨(limit=1000) | 10,916ms (10.9ç§’) | 20 | 2æ¡/ç§’ | ğŸ”´ æ…¢ |
| æ ¹æ®IDæŸ¥è¯¢è½¨è¿¹ | 2,752ms (2.75ç§’) | 1 | 0.4æ¡/ç§’ | ğŸŸ¡ ä¸­ç­‰ |
| ç­›é€‰æŸ¥è¯¢(æŒ‰data_id) | 2,446ms (2.4ç§’) | 0 | N/A | ğŸŸ¡ ä¸­ç­‰ |
| ç­›é€‰æŸ¥è¯¢(æŒ‰rewardèŒƒå›´) | 2,376ms (2.4ç§’) | 0 | N/A | ğŸŸ¡ ä¸­ç­‰ |
| ç­›é€‰æŸ¥è¯¢(ç»„åˆæ¡ä»¶) | 2,342ms (2.3ç§’) | 0 | N/A | ğŸŸ¡ ä¸­ç­‰ |
| å¤šæ¬¡æŸ¥è¯¢å¹³å‡(10æ¬¡) | 11,527ms (11.5ç§’) | 100 | 9æ¡/ç§’ | ğŸ”´ æ…¢ |
| å‘é‡æœç´¢ | å¤±è´¥ (404) | N/A | N/A | ğŸ”´ ä¸å¯ç”¨ |

### å¹¶å‘æŸ¥è¯¢æ€§èƒ½

| å¹¶å‘çº§åˆ« | æ€»è€—æ—¶ | å¹³å‡å“åº”æ—¶é—´ | ååé‡ | çŠ¶æ€ |
|---------|--------|-------------|--------|------|
| 1 | 10,995ms (11ç§’) | 10,994ms | 0.09è¯·æ±‚/ç§’ | ğŸ”´ |
| 5 | 55,772ms (56ç§’) | 46,937ms (47ç§’) | 0.09è¯·æ±‚/ç§’ | ğŸ”´ |
| 10 | 107,162ms (107ç§’) | 82,579ms (83ç§’) | 0.09è¯·æ±‚/ç§’ | ğŸ”´ |
| 20 | 226,822ms (227ç§’) | 196,826ms (197ç§’) | 0.09è¯·æ±‚/ç§’ | ğŸ”´ |

### æŸ¥è¯¢æ€§èƒ½é—®é¢˜åˆ†æ

#### é—®é¢˜1: ç»Ÿè®¡ä¿¡æ¯æŸ¥è¯¢ææ…¢ (43ç§’)

**å¯èƒ½åŸå› **:
- å…¨è¡¨æ‰«æè®¡ç®—ç»Ÿè®¡æ•°æ®
- æ²¡æœ‰ç¼“å­˜æœºåˆ¶
- å¯èƒ½æ¯æ¬¡éƒ½é‡æ–°è®¡ç®—æ‰€æœ‰æŒ‡æ ‡

**å½±å“**: é¦–é¡µåŠ è½½ä¼šéå¸¸æ…¢

#### é—®é¢˜2: åˆ†é¡µæŸ¥è¯¢é™åˆ¶æœªç”Ÿæ•ˆ

**ç°è±¡**: è¯·æ±‚100æ¡å’Œ1000æ¡éƒ½åªè¿”å›20æ¡è®°å½•

**å¯èƒ½åŸå› **:
- APIè·¯ç”±é…ç½®é—®é¢˜
- æ•°æ®ä»“åº“çš„`limit`å‚æ•°æœªæ­£ç¡®ä¼ é€’
- åç«¯ç¡¬ç¼–ç äº†é™åˆ¶

#### é—®é¢˜3: å¹¶å‘æŸ¥è¯¢æ€§èƒ½çº¿æ€§ä¸‹é™

**ç°è±¡**: å¹¶å‘å¢åŠ æ—¶ï¼Œå“åº”æ—¶é—´å‡ ä¹æˆå€å¢é•¿

**å¯èƒ½åŸå› **:
- æ•°æ®åº“æŸ¥è¯¢æ˜¯é˜»å¡çš„
- æ²¡æœ‰è¿æ¥æ± ä¼˜åŒ–
- LanceDBå¯èƒ½ä¸æ˜¯ä¸ºé«˜å¹¶å‘è®¾è®¡çš„

#### é—®é¢˜4: å‘é‡æœç´¢ä¸å¯ç”¨ (404)

**é—®é¢˜**: æœç´¢ç«¯ç‚¹è¿”å›404

**å¯èƒ½åŸå› **: è·¯ç”±æœªæ­£ç¡®é…ç½®

### æŸ¥è¯¢ä¼˜åŒ–å»ºè®®

#### ä¼˜å…ˆçº§1: ç»Ÿè®¡ä¿¡æ¯ç¼“å­˜

```python
# ä½¿ç”¨ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯ï¼Œå®šæœŸåˆ·æ–°
@lru_cache(maxsize=1)
def get_stats():
    # è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
    pass

# æˆ–è®¾ç½®å®šæœŸåˆ·æ–°
stats_cache = {"data": None, "updated_at": 0}
if time.time() - stats_cache["updated_at"] > 60:  # 60ç§’ç¼“å­˜
    stats_cache["data"] = calculate_stats()
```

**é¢„æœŸæ•ˆæœ**: ä»43ç§’é™ä½åˆ° <100ms (é¦–æ¬¡è®¡ç®—å)

#### ä¼˜å…ˆçº§2: ä¿®å¤åˆ†é¡µé™åˆ¶

æ£€æŸ¥è·¯ç”±å¤„ç†é€»è¾‘ï¼Œç¡®ä¿limitå‚æ•°æ­£ç¡®ä¼ é€’åˆ°æ•°æ®åº“æŸ¥è¯¢å±‚ã€‚

#### ä¼˜å…ˆçº§3: æ·»åŠ æ•°æ®åº“ç´¢å¼•

ä¸ºå¸¸ç”¨ç­›é€‰å­—æ®µæ·»åŠ ç´¢å¼•ï¼š
- data_id
- agent_name
- reward
- created_at

#### ä¼˜å…ˆçº§4: æŸ¥è¯¢ç»“æœç¼“å­˜

å¯¹çƒ­ç‚¹æŸ¥è¯¢æ·»åŠ ç¼“å­˜ï¼š
- æœ€è¿‘æŸ¥è¯¢ç»“æœ
- å¸¸ç”¨ç­›é€‰æ¡ä»¶ç»„åˆ

#### ä¼˜å…ˆçº§5: åˆ†é¡µåŠ è½½ä¼˜åŒ–

ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µä»£æ›¿åç§»åˆ†é¡µï¼š
- é¿å…æ·±åˆ†é¡µæ€§èƒ½é—®é¢˜
- æ”¯æŒæ— é™æ»šåŠ¨

### æŸ¥è¯¢æ€§èƒ½ç»“è®º

æŸ¥è¯¢æ€§èƒ½ä¸å¯¼å…¥æ€§èƒ½åŒæ ·å­˜åœ¨ä¸¥é‡é—®é¢˜ï¼š

1. **æœ€ç®€å•çš„ç»Ÿè®¡æŸ¥è¯¢éœ€è¦43ç§’** - ç”¨æˆ·ä½“éªŒæå·®
2. **åˆ†é¡µæŸ¥è¯¢é™åˆ¶æœªç”Ÿæ•ˆ** - å¯èƒ½å½±å“æ•°æ®å±•ç¤º
3. **å¹¶å‘æ”¯æŒå·®** - æ— æ³•æ”¯æŒå¤šç”¨æˆ·åŒæ—¶ä½¿ç”¨
4. **å‘é‡æœç´¢ä¸å¯ç”¨** - æ ¸å¿ƒåŠŸèƒ½ç¼ºå¤±

**å»ºè®®ä¼˜å…ˆçº§**:
1. **ç«‹å³ä¿®å¤**: ç»Ÿè®¡ä¿¡æ¯ç¼“å­˜ - æœ€å¤§ç”¨æˆ·ä½“éªŒæå‡
2. **ç«‹å³ä¿®å¤**: åˆ†é¡µé™åˆ¶é—®é¢˜ - ç¡®ä¿åŠŸèƒ½æ­£å¸¸
3. **çŸ­æœŸ**: ä¿®å¤å‘é‡æœç´¢ - æ¢å¤æ ¸å¿ƒåŠŸèƒ½
4. **ä¸­æœŸ**: æ·»åŠ ç´¢å¼•å’Œç¼“å­˜ - æå‡æ•´ä½“æŸ¥è¯¢æ€§èƒ½

---

## é™„å½•ï¼šä»£ç ä½ç½®

- å¯¼å…¥æœåŠ¡: `backend/services/import_service.py:348-533`
- æ•°æ®ä»“åº“: `backend/repositories/trajectory.py:230-238`
- æ‰¹é‡æ’å…¥æ–¹æ³•: `backend/repositories/trajectory.py:235-238` (å·²å®ç°ä½†æœªä½¿ç”¨)
- æŸ¥è¯¢æµ‹è¯•è„šæœ¬: `test_query_performance.py`

